# TeleComfy Bot

[English](/README.md) • <u>**Русский**</u> • [中文](/README.zh.md)

**TeleComfy** - умный Telegram‑бот для супергрупп с форумными темами: генерирует изображения, видео и аудио через интеграцию с ComfyUI по вашим сообщениям в нужных темах. Где каждая тема является отдельным полноценным workflow ComfyUI. Бот поддерживает очереди с лимитами, отмену задач, повторную генерацию, мультиязычный интерфейс (ru/en/zh) и работу с альбомами изображений.

## Основные возможности

- Генерация через ComfyUI: POST /prompt + WebSocket /ws + /history → /view
- Работа строго в одной супергруппе (без приватных чатов и других групп)
- Тематические ветки (forum topics): отдельные workflow ComfyUI для каждой темы (txt2img, img2img, txt2video, txt2audio и др.)
- Очередь задач:
  - Глобальный лимит воркеров и лимит на тему
  - Персональный лимит ожидающих задач на пользователя
  - Кнопка «Отменить» — доступна, пока задача в ожидании
- Повторная генерация по кнопке — с сохранением исходных параметров/альбомов
- Поддержка альбомов (до 10 изображений) для тем, где нужно несколько входных картинок, например: Qwen-Image-Edit-2509
- Инлайн‑параметры в сообщениях: steps, width, height, seed, fps, length и др.
  - Конфигурация для каждой темы набора разрешенных параметров
  - Конфигурация диапазона допустимых значений для каждого разрешенного параметра для каждой темы
- Подписи к результатам с реальным временем ожидания/генерации
- Локализации интерфейса Telegram: ru, en, zh

## Требования

- Python 3.11+
- Запущенный ComfyUI (локально или по сети), доступный по адресу из `COMFY_BASE_URL`
- Telegram‑бот с токеном BotFather
- Супергруппа с включёнными темами форума (Forum Topics), где бот — администратор с правами управления темами

## Быстрый старт

1) Клонируйте репозиторий и установите зависимости:
  ```
  pip install -r requirements.txt
  ```

2) Поднимите ComfyUI
- Убедитесь, что ComfyUI доступен по `http://127.0.0.1:8000` (или вашему URL)

3) Подготовьте .env
- Скопируйте `.env.example` в `.env` и заполните ключевые параметры:
  ```
  TELEGRAM_TOKEN=123456:ABCDEF-your-token
  ALLOWED_CHAT_ID=-100xxxxxxxxxx
  COMFY_BASE_URL=http://127.0.0.1:8000
  # COMFY_API_KEY=  # укажите при необходимости защиты API ComfyUI
  ```
- Как получить `ALLOWED_CHAT_ID`:
  - Создайте супергруппу, включите «Темы форума»
  - Добавьте бота админом с правами «управление темами»
  - Узнайте ID чата через @getidsbot или похожие инструменты

4) Темы (режимы)
- В проект уже включены примеры тем c workflow'ами для режимов: `txt2img`, `img2img`, `album_img2img`, `txt2video`, `img2video`, `txt2audio`
- При первом запуске просто выполните синхронизацию тем (см. ниже)

5) Запуск
```
python -m app.main
```

6) Синхронизация тем
- В заданной супергруппе (ALLOWED_CHAT_ID) отправьте команду от имени администратора:
  ```
  /topic_scan
  ```
- Бот создаст/обновит форумные темы согласно конфигурациям из `data/topics` и привяжет их по alias

## Как пользоваться

- Пишите в соответствующей теме форума:
  - Текст без картинки — для тем txt2img/txt2video/txt2audio
  - Фото с подписью — для img2img/img2video
  - Альбом из нескольких фото (до 10) — для тем, где требуется несколько входных изображений (например, Qwen-Image-Edit-2509)
- Бот ответит «плейсхолдером» (картинкой ожидания). Когда генерация завершится:
  - Сообщение отредактируется на итоговый результат (первая медиа)
  - Остальные результаты (если есть) придут следом альбомом
- Под результатом есть кнопка:
  - «Повторить генерацию» — запустит новую задачу с теми же параметрами
  - «Отменить» — доступна, пока задача ждёт в очереди

## Инлайн‑параметры

Добавляйте к сообщению быстрые настройки:

- Скаляры:
  - `steps=30 width=768 height=1344 seed=123`
  - Для видео/аудио: `fps=24 length=5.0`
- Длинный текстовый блок(может быть необходим для генерации песен с текстами):
  - Вариант 1:
    ```
    text```Многострочный текст здесь
    С переносами строк
    `` `
    ```
  - Вариант 2: `text: описание до конца сообщения`
  - Вариант 3: `text="любой текст в кавычках"`

Примеры сообщений:
- Простой prompt:
  ```
  cinematic portrait, rim light, 85mm, f1.8
  width=768 height=1152
  ```
- Для img2img (в теме img2img): отправьте фото с подписью:
  ```
  watercolor style, high contrast
  steps=30
  ```
- Для темы, поддерживающей несколько входных изображений: отправьте альбом (до 10 фото) и добавьте подпись с параметрами.

Замечания:
- Доступность параметров зависит от конкретной темы и её конфигурации
- В некоторых темах (доступных по умолчанию) значения ограничены (минимум/максимум); бот аккуратно подгоняет ширину/высоту пропорционально допустимым границам

## Полезные настройки

- Лимиты и таймауты (в .env):
  - `LIMITS_MAX_WORKERS` — глобальный максимум параллельных задач
  - `LIMITS_PER_TOPIC` — параллелизм на тему
  - `LIMITS_PER_USER_PENDING` — сколько задач пользователь может держать «в ожидании» (до старта)
  - `TIMEOUT_WS`, `TIMEOUT_RUN` — таймауты подключения к WS и всей генерации
- Локализация:
  - `LOCALE=ru|en|zh`
- Защита ComfyUI:
  - `COMFY_API_KEY` — если есть проверка токена на стороне ComfyUI/прокси

## Подсказки и частые проблемы

- «Эта тема не сконфигурирована. Администратору: выполните /topic_scan.»
  - Запустите `/topic_scan` от администратора в нужной супергруппе
- Плейсхолдер висит слишком долго:
  - Проверьте соединение с ComfyUI (`COMFY_BASE_URL`)
  - Увеличьте таймауты `TIMEOUT_WS`/`TIMEOUT_RUN`, если нужно
- «У вас уже есть N ожидающих задач(и). Лимит: N. Пожалуйста, дождитесь завершения.»
  - Достигнут персональный лимит ожидания. Подождите завершения части задач или отмените их
- Диагностика:
  - Повысить уровень логирования: `LOG_LEVEL=DEBUG`

—

Приятной генерации!